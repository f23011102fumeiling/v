# 智能教学平台数据库设计文档

## 文档信息
- **项目名称**: 智能教学平台
- **版本**: v1.0.0
- **创建日期**: 2026-01-26
- **数据库类型**: PostgreSQL
- **字符编码**: UTF-8

---

## 数据库概述

本系统主要包含用户管理、问卷管理、智能问答、知识库等核心功能模块。采用PostgreSQL作为主数据库，支持向量数据库（pgvector/ChromaDB）用于知识库的语义检索。

---

## 1. 用户模块

### 1.1 用户表 (users)

存储系统所有用户信息，包括学生和教师。

| 字段名 | 数据类型 | 长度 | 是否必填 | 默认值 | 说明 |
|--------|---------|------|---------|--------|------|
| id | UUID | - | 是 | uuid_generate_v4() | 主键，用户唯一标识 |
| username | VARCHAR | 50 | 是 | - | 用户名，唯一 |
| email | VARCHAR | 100 | 是 | - | 邮箱，唯一 |
| password_hash | VARCHAR | 255 | 是 | - | 密码哈希值 |
| role | VARCHAR | 20 | 是 | 'student' | 角色：student/teacher |
| full_name | VARCHAR | 100 | 否 | - | 真实姓名 |
| avatar_url | VARCHAR | 500 | 否 | - | 头像URL |
| is_active | BOOLEAN | - | 是 | true | 账号是否激活 |
| created_at | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 更新时间 |
| last_login_at | TIMESTAMP | - | 否 | - | 最后登录时间 |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE INDEX: `idx_users_username` ON `username`
- UNIQUE INDEX: `idx_users_email` ON `email`
- INDEX: `idx_users_role` ON `role`

### 1.2 学生表 (students)

存储学生专属信息。

| 字段名 | 数据类型 | 长度 | 是否必填 | 默认值 | 说明 |
|--------|---------|------|---------|--------|------|
| id | UUID | - | 是 | uuid_generate_v4() | 主键 |
| user_id | UUID | - | 是 | - | 用户ID，外键 |
| student_number | VARCHAR | 50 | 是 | - | 学号，唯一 |
| major | VARCHAR | 100 | 否 | - | 专业 |
| grade | VARCHAR | 20 | 否 | - | 年级 |
| class_name | VARCHAR | 50 | 否 | - | 班级 |
| total_questions | INTEGER | - | 是 | 0 | 提问总数 |
| total_scores | DECIMAL | (10,2) | 是 | 0.00 | 总分数 |
| created_at | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 更新时间 |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE INDEX: `idx_students_number` ON `student_number`
- UNIQUE INDEX: `idx_students_user` ON `user_id`
- INDEX: `idx_students_grade_class` ON `(grade, class_name)`
- FOREIGN KEY: `user_id` REFERENCES `users(id)` ON DELETE CASCADE

### 1.3 教师表 (teachers)

存储教师专属信息。

| 字段名 | 数据类型 | 长度 | 是否必填 | 默认值 | 说明 |
|--------|---------|------|---------|--------|------|
| id | UUID | - | 是 | uuid_generate_v4() | 主键 |
| user_id | UUID | - | 是 | - | 用户ID，外键 |
| teacher_number | VARCHAR | 50 | 是 | - | 工号，唯一 |
| department | VARCHAR | 100 | 否 | - | 所属院系 |
| title | VARCHAR | 50 | 否 | - | 职称 |
| courses | JSONB | - | 否 | - | 授课课程列表 |
| created_at | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 更新时间 |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE INDEX: `idx_teachers_number` ON `teacher_number`
- UNIQUE INDEX: `idx_teachers_user` ON `user_id`
- INDEX: `idx_teachers_department` ON `department`
- FOREIGN KEY: `user_id` REFERENCES `users(id)` ON DELETE CASCADE

---

## 2. 课程与班级模块

### 2.1 课程表 (courses)

存储课程基本信息。

| 字段名 | 数据类型 | 长度 | 是否必填 | 默认值 | 说明 |
|--------|---------|------|---------|--------|------|
| id | UUID | - | 是 | uuid_generate_v4() | 主键 |
| course_code | VARCHAR | 50 | 是 | - | 课程代码，唯一 |
| course_name | VARCHAR | 200 | 是 | - | 课程名称 |
| description | TEXT | - | 否 | - | 课程描述 |
| teacher_id | UUID | - | 是 | - | 授课教师ID，外键 |
| semester | VARCHAR | 50 | 否 | - | 学期：2024-春季 |
| credit | DECIMAL | (3,1) | 否 | - | 学分 |
| status | VARCHAR | 20 | 是 | 'active' | 状态：active/archived |
| created_at | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 更新时间 |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE INDEX: `idx_courses_code` ON `course_code`
- INDEX: `idx_courses_teacher` ON `teacher_id`
- FOREIGN KEY: `teacher_id` REFERENCES `users(id)`

### 2.2 班级表 (classes)

存储班级信息。

| 字段名 | 数据类型 | 长度 | 是否必填 | 默认值 | 说明 |
|--------|---------|------|---------|--------|------|
| id | UUID | - | 是 | uuid_generate_v4() | 主键 |
| class_name | VARCHAR | 100 | 是 | - | 班级名称 |
| course_id | UUID | - | 是 | - | 所属课程ID |
| teacher_id | UUID | - | 是 | - | 班级教师ID |
| max_students | INTEGER | - | 否 | 100 | 最大学生数 |
| academic_year | VARCHAR | 20 | 否 | - | 学年：2024-2025 |
| status | VARCHAR | 20 | 是 | 'active' | 状态 |
| created_at | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 更新时间 |

**索引**:
- PRIMARY KEY: `id`
- INDEX: `idx_classes_course` ON `course_id`
- INDEX: `idx_classes_teacher` ON `teacher_id`
- FOREIGN KEY: `course_id` REFERENCES `courses(id)`
- FOREIGN KEY: `teacher_id` REFERENCES `users(id)`

### 2.3 班级学生关联表 (class_students)

学生与班级的多对多关系。

| 字段名 | 数据类型 | 长度 | 是否必填 | 默认值 | 说明 |
|--------|---------|------|---------|--------|------|
| id | UUID | - | 是 | uuid_generate_v4() | 主键 |
| class_id | UUID | - | 是 | - | 班级ID |
| student_id | UUID | - | 是 | - | 学生ID |
| enrollment_date | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 加入时间 |
| status | VARCHAR | 20 | 是 | 'active' | 状态：active/dropped |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE INDEX: `idx_class_students_unique` ON `(class_id, student_id)`
- INDEX: `idx_class_students_student` ON `student_id`
- FOREIGN KEY: `class_id` REFERENCES `classes(id)`
- FOREIGN KEY: `student_id` REFERENCES `users(id)`

---

## 3. 问卷模块

### 3.1 问卷表 (surveys)

存储问卷基本信息。

| 字段名 | 数据类型 | 长度 | 是否必填 | 默认值 | 说明 |
|--------|---------|------|---------|--------|------|
| id | UUID | - | 是 | uuid_generate_v4() | 主键 |
| title | VARCHAR | 200 | 是 | - | 问卷标题 |
| description | TEXT | - | 否 | - | 问卷描述 |
| teacher_id | UUID | - | 是 | - | 创建教师ID |
| course_id | UUID | - | 否 | - | 关联课程ID |
| class_id | UUID | - | 否 | - | 关联班级ID |
| survey_type | VARCHAR | 50 | 是 | 'questionnaire' | 问卷类型：questionnaire(纯问卷)/exam(测验) |
| target_students | JSONB | - | 否 | - | 目标学生ID列表（空表示全班） |
| generation_method | VARCHAR | 50 | 是 | 'manual' | 生成方式：manual/ai/knowledge_base |
| generation_prompt | TEXT | - | 否 | - | AI生成时的提示词 |
| status | VARCHAR | 20 | 是 | 'draft' | 状态：draft/published/closed/archived |
| total_score | INTEGER | - | 否 | 100 | 总分 |
| pass_score | INTEGER | - | 否 | 60 | 及格分数 |
| time_limit | INTEGER | - | 否 | - | 答题时限（分钟） |
| allow_multiple_attempts | BOOLEAN | - | 是 | false | 是否允许多次作答 |
| max_attempts | INTEGER | - | 否 | 1 | 最大作答次数 |
| show_answer | BOOLEAN | - | 是 | false | 是否显示答案 |
| shuffle_questions | BOOLEAN | - | 是 | false | 是否打乱题目顺序 |
| start_time | TIMESTAMP | - | 否 | - | 开始时间 |
| end_time | TIMESTAMP | - | 否 | - | 结束时间 |
| created_at | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 更新时间 |
| published_at | TIMESTAMP | - | 否 | - | 发布时间 |

**索引**:
- PRIMARY KEY: `id`
- INDEX: `idx_surveys_teacher` ON `teacher_id`
- INDEX: `idx_surveys_course` ON `course_id`
- INDEX: `idx_surveys_status` ON `status`
- INDEX: `idx_surveys_created` ON `created_at`
- FOREIGN KEY: `teacher_id` REFERENCES `users(id)`
- FOREIGN KEY: `course_id` REFERENCES `courses(id)`
- FOREIGN KEY: `class_id` REFERENCES `classes(id)`

### 3.2 问题表 (questions)

存储问卷中的所有题目。

| 字段名 | 数据类型 | 长度 | 是否必填 | 默认值 | 说明 |
|--------|---------|------|---------|--------|------|
| id | UUID | - | 是 | uuid_generate_v4() | 主键 |
| survey_id | UUID | - | 是 | - | 所属问卷ID |
| question_type | VARCHAR | 50 | 是 | - | 题型：single_choice/multiple_choice/true_false/short_answer/essay/coding |
| question_text | TEXT | - | 是 | - | 题目内容 |
| question_order | INTEGER | - | 是 | - | 题目顺序 |
| score | DECIMAL | (10,2) | 是 | 0 | 题目分值 |
| difficulty | VARCHAR | 20 | 否 | 'medium' | 难度：easy/medium/hard |
| options | JSONB | - | 否 | - | 选项（JSON格式） |
| correct_answer | JSONB | - | 否 | - | 正确答案（JSON格式） |
| answer_explanation | TEXT | - | 否 | - | 答案解析 |
| tags | TEXT[] | - | 否 | - | 标签数组 |
| knowledge_points | TEXT[] | - | 否 | - | 知识点数组 |
| is_required | BOOLEAN | - | 是 | true | 是否必答 |
| created_at | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 更新时间 |

**索引**:
- PRIMARY KEY: `id`
- INDEX: `idx_questions_survey` ON `survey_id`
- INDEX: `idx_questions_order` ON `(survey_id, question_order)`
- INDEX: `idx_questions_type` ON `question_type`
- FOREIGN KEY: `survey_id` REFERENCES `surveys(id)` ON DELETE CASCADE

**JSONB 字段说明**:

options 示例（选择题）:
```json
[
  {"key": "A", "value": "选项A的内容"},
  {"key": "B", "value": "选项B的内容"},
  {"key": "C", "value": "选项C的内容"},
  {"key": "D", "value": "选项D的内容"}
]
```

correct_answer 示例:
```json
{
  "single_choice": "A",
  "multiple_choice": ["A", "C"],
  "true_false": true,
  "fill_blank": ["答案1", "答案2"],
  "essay": "参考答案或评分标准"
}
```

### 3.3 问卷回答表 (survey_responses)

存储学生对问卷的作答记录。

| 字段名 | 数据类型 | 长度 | 是否必填 | 默认值 | 说明 |
|--------|---------|------|---------|--------|------|
| id | UUID | - | 是 | uuid_generate_v4() | 主键 |
| survey_id | UUID | - | 是 | - | 问卷ID |
| student_id | UUID | - | 是 | - | 学生ID |
| attempt_number | INTEGER | - | 是 | 1 | 第几次作答 |
| total_score | DECIMAL | (5,2) | 否 | - | 总得分 |
| percentage_score | DECIMAL | (5,2) | 否 | - | 得分百分比 |
| is_passed | BOOLEAN | - | 否 | - | 是否及格 |
| status | VARCHAR | 20 | 是 | 'in_progress' | 状态：in_progress/submitted/graded |
| start_time | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 开始时间 |
| submit_time | TIMESTAMP | - | 否 | - | 提交时间 |
| time_spent | INTEGER | - | 否 | - | 用时（秒） |
| ip_address | VARCHAR | 50 | 否 | - | 答题IP地址 |
| user_agent | TEXT | - | 否 | - | 浏览器信息 |
| created_at | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 更新时间 |

**索引**:
- PRIMARY KEY: `id`
- INDEX: `idx_responses_survey` ON `survey_id`
- INDEX: `idx_responses_student` ON `student_id`
- UNIQUE INDEX: `idx_responses_unique` ON `(survey_id, student_id, attempt_number)`
- INDEX: `idx_responses_status` ON `status`
- FOREIGN KEY: `survey_id` REFERENCES `surveys(id)`
- FOREIGN KEY: `student_id` REFERENCES `users(id)`

### 3.4 答案表 (answers)

存储学生对每道题的具体答案。

| 字段名 | 数据类型 | 长度 | 是否必填 | 默认值 | 说明 |
|--------|---------|------|---------|--------|------|
| id | UUID | - | 是 | uuid_generate_v4() | 主键 |
| response_id | UUID | - | 是 | - | 答卷ID |
| question_id | UUID | - | 是 | - | 题目ID |
| student_answer | JSONB | - | 否 | - | 学生答案（JSON格式） |
| is_correct | BOOLEAN | - | 否 | - | 是否正确（客观题） |
| score | DECIMAL | (5,2) | 否 | 0 | 得分 |
| teacher_comment | TEXT | - | 否 | - | 教师评语 |
| auto_graded | BOOLEAN | - | 是 | false | 是否自动评分 |
| graded_by | UUID | - | 否 | - | 评分教师ID |
| graded_at | TIMESTAMP | - | 否 | - | 评分时间 |
| created_at | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 更新时间 |

**索引**:
- PRIMARY KEY: `id`
- INDEX: `idx_answers_response` ON `response_id`
- INDEX: `idx_answers_question` ON `question_id`
- UNIQUE INDEX: `idx_answers_unique` ON `(response_id, question_id)`
- FOREIGN KEY: `response_id` REFERENCES `survey_responses(id)` ON DELETE CASCADE
- FOREIGN KEY: `question_id` REFERENCES `questions(id)`
- FOREIGN KEY: `graded_by` REFERENCES `users(id)`

### 3.5 问卷提交记录表 (questionnaire_submissions)

存储学生的问卷提交记录汇总。

| 字段名 | 数据类型 | 长度 | 是否必填 | 默认值 | 说明 |
|--------|---------|------|---------|--------|------|
| id | UUID | - | 是 | uuid_generate_v4() | 主键 |
| survey_id | UUID | - | 是 | - | 问卷ID |
| student_id | UUID | - | 是 | - | 学生ID |
| total_score | DECIMAL | (10,2) | 否 | - | 总得分（测验模式） |
| time_spent | INTEGER | - | 是 | 0 | 总用时（秒） |
| submit_time | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 提交时间 |
| created_at | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE INDEX: `idx_submissions_unique` ON `(survey_id, student_id)`
- INDEX: `idx_submissions_student` ON `student_id`
- INDEX: `idx_submissions_time` ON `submit_time`
- FOREIGN KEY: `survey_id` REFERENCES `surveys(id)` ON DELETE CASCADE
- FOREIGN KEY: `student_id` REFERENCES `students(id)` ON DELETE CASCADE

---

## 4. 智能问答模块

### 4.1 问答记录表 (qa_records)

存储学生与AI的问答历史。

| 字段名 | 数据类型 | 长度 | 是否必填 | 默认值 | 说明 |
|--------|---------|------|---------|--------|------|
| id | UUID | - | 是 | uuid_generate_v4() | 主键 |
| student_id | UUID | - | 是 | - | 学生ID |
| course_id | UUID | - | 否 | - | 关联课程ID |
| question | TEXT | - | 是 | - | 学生提问 |
| answer | TEXT | - | 否 | - | AI回答 |
| answer_type | VARCHAR | 50 | 否 | - | 回答类型：ai/knowledge_base |
| context_used | JSONB | - | 否 | - | 使用的上下文信息 |
| knowledge_sources | JSONB | - | 否 | - | 引用的知识库来源 |
| confidence_score | DECIMAL | (3,2) | 否 | - | 置信度分数（0-1） |
| is_helpful | BOOLEAN | - | 否 | - | 学生反馈是否有帮助 |
| feedback | TEXT | - | 否 | - | 学生反馈内容 |
| response_time | INTEGER | - | 否 | - | 响应时间（毫秒） |
| tokens_used | INTEGER | - | 否 | - | 使用的token数量 |
| created_at | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY: `id`
- INDEX: `idx_qa_student` ON `student_id`
- INDEX: `idx_qa_course` ON `course_id`
- INDEX: `idx_qa_created` ON `created_at`
- FOREIGN KEY: `student_id` REFERENCES `users(id)`
- FOREIGN KEY: `course_id` REFERENCES `courses(id)`

### 4.2 问答会话表 (qa_sessions)

存储连续对话的会话信息。

| 字段名 | 数据类型 | 长度 | 是否必填 | 默认值 | 说明 |
|--------|---------|------|---------|--------|------|
| id | UUID | - | 是 | uuid_generate_v4() | 主键 |
| student_id | UUID | - | 是 | - | 学生ID |
| title | VARCHAR | 200 | 否 | - | 会话标题 |
| course_id | UUID | - | 否 | - | 关联课程 |
| message_count | INTEGER | - | 是 | 0 | 消息数量 |
| is_active | BOOLEAN | - | 是 | true | 是否活跃 |
| created_at | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 更新时间 |
| last_message_at | TIMESTAMP | - | 否 | - | 最后消息时间 |

**索引**:
- PRIMARY KEY: `id`
- INDEX: `idx_sessions_student` ON `student_id`
- INDEX: `idx_sessions_updated` ON `updated_at`
- FOREIGN KEY: `student_id` REFERENCES `users(id)`
- FOREIGN KEY: `course_id` REFERENCES `courses(id)`

---

## 5. 知识库模块

### 5.1 知识库文档表 (knowledge_documents)

存储上传的知识库文档。

| 字段名 | 数据类型 | 长度 | 是否必填 | 默认值 | 说明 |
|--------|---------|------|---------|--------|------|
| id | UUID | - | 是 | uuid_generate_v4() | 主键 |
| title | VARCHAR | 200 | 是 | - | 文档标题 |
| description | TEXT | - | 否 | - | 文档描述 |
| content | TEXT | - | 否 | - | 文档内容（纯文本） |
| file_url | VARCHAR | 500 | 否 | - | 原文件URL |
| file_type | VARCHAR | 50 | 否 | - | 文件类型：pdf/docx/txt |
| file_size | BIGINT | - | 否 | - | 文件大小（字节） |
| teacher_id | UUID | - | 是 | - | 上传教师ID |
| course_id | UUID | - | 否 | - | 关联课程ID |
| category | VARCHAR | 100 | 否 | - | 分类 |
| tags | TEXT[] | - | 否 | - | 标签数组 |
| version | VARCHAR | 50 | 否 | '1.0' | 版本号 |
| status | VARCHAR | 20 | 是 | 'processing' | 状态：processing/indexed/failed |
| chunk_count | INTEGER | - | 否 | 0 | 切片数量 |
| vector_db_id | VARCHAR | 255 | 否 | - | 向量数据库中的ID |
| indexed_at | TIMESTAMP | - | 否 | - | 索引完成时间 |
| created_at | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 更新时间 |

**索引**:
- PRIMARY KEY: `id`
- INDEX: `idx_documents_teacher` ON `teacher_id`
- INDEX: `idx_documents_course` ON `course_id`
- INDEX: `idx_documents_status` ON `status`
- INDEX: `idx_documents_created` ON `created_at`
- FOREIGN KEY: `teacher_id` REFERENCES `users(id)`
- FOREIGN KEY: `course_id` REFERENCES `courses(id)`

### 5.2 文档片段表 (document_chunks)

存储文档切片信息（用于检索）。

| 字段名 | 数据类型 | 长度 | 是否必填 | 默认值 | 说明 |
|--------|---------|------|---------|--------|------|
| id | UUID | - | 是 | uuid_generate_v4() | 主键 |
| document_id | UUID | - | 是 | - | 文档ID |
| chunk_index | INTEGER | - | 是 | - | 片段序号 |
| content | TEXT | - | 是 | - | 片段内容 |
| embedding_vector | VECTOR | (1536) | 否 | - | 向量嵌入（pgvector） |
| token_count | INTEGER | - | 否 | - | token数量 |
| metadata | JSONB | - | 否 | - | 元数据 |
| created_at | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY: `id`
- INDEX: `idx_chunks_document` ON `document_id`
- INDEX: `idx_chunks_vector` ON `embedding_vector` USING ivfflat (如使用pgvector)
- FOREIGN KEY: `document_id` REFERENCES `knowledge_documents(id)` ON DELETE CASCADE

---

## 6. 统计分析模块

### 6.1 学生学习统计表 (student_statistics)

存储学生的学习统计数据（定期汇总）。

| 字段名 | 数据类型 | 长度 | 是否必填 | 默认值 | 说明 |
|--------|---------|------|---------|--------|------|
| id | UUID | - | 是 | uuid_generate_v4() | 主键 |
| student_id | UUID | - | 是 | - | 学生ID |
| course_id | UUID | - | 否 | - | 课程ID |
| period | VARCHAR | 50 | 是 | - | 统计周期：daily/weekly/monthly |
| period_date | DATE | - | 是 | - | 周期日期 |
| total_questions_answered | INTEGER | - | 是 | 0 | 总问答数 |
| total_surveys_completed | INTEGER | - | 是 | 0 | 完成问卷数 |
| average_score | DECIMAL | (5,2) | 否 | - | 平均分数 |
| total_study_time | INTEGER | - | 是 | 0 | 总学习时长（分钟） |
| active_days | INTEGER | - | 是 | 0 | 活跃天数 |
| created_at | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 更新时间 |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE INDEX: `idx_stats_unique` ON `(student_id, course_id, period, period_date)`
- INDEX: `idx_stats_student` ON `student_id`
- INDEX: `idx_stats_course` ON `course_id`
- INDEX: `idx_stats_period` ON `period_date`
- FOREIGN KEY: `student_id` REFERENCES `users(id)`
- FOREIGN KEY: `course_id` REFERENCES `courses(id)`

### 6.2 问卷统计表 (survey_statistics)

存储问卷的统计分析数据。

| 字段名 | 数据类型 | 长度 | 是否必填 | 默认值 | 说明 |
|--------|---------|------|---------|--------|------|
| id | UUID | - | 是 | uuid_generate_v4() | 主键 |
| survey_id | UUID | - | 是 | - | 问卷ID |
| total_participants | INTEGER | - | 是 | 0 | 总参与人数 |
| total_completed | INTEGER | - | 是 | 0 | 完成人数 |
| completion_rate | DECIMAL | (5,2) | 否 | - | 完成率 |
| average_score | DECIMAL | (5,2) | 否 | - | 平均分 |
| highest_score | DECIMAL | (5,2) | 否 | - | 最高分 |
| lowest_score | DECIMAL | (5,2) | 否 | - | 最低分 |
| pass_rate | DECIMAL | (5,2) | 否 | - | 及格率 |
| average_time | INTEGER | - | 否 | - | 平均用时（秒） |
| question_analysis | JSONB | - | 否 | - | 各题统计分析 |
| last_calculated_at | TIMESTAMP | - | 否 | - | 最后计算时间 |
| created_at | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 更新时间 |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE INDEX: `idx_survey_stats_unique` ON `survey_id`
- FOREIGN KEY: `survey_id` REFERENCES `surveys(id)` ON DELETE CASCADE

---

## 7. 系统日志模块

### 7.1 操作日志表 (operation_logs)

记录系统重要操作。

| 字段名 | 数据类型 | 长度 | 是否必填 | 默认值 | 说明 |
|--------|---------|------|---------|--------|------|
| id | UUID | - | 是 | uuid_generate_v4() | 主键 |
| user_id | UUID | - | 否 | - | 操作用户ID |
| action | VARCHAR | 100 | 是 | - | 操作类型 |
| resource_type | VARCHAR | 50 | 否 | - | 资源类型 |
| resource_id | UUID | - | 否 | - | 资源ID |
| description | TEXT | - | 否 | - | 操作描述 |
| ip_address | VARCHAR | 50 | 否 | - | IP地址 |
| user_agent | TEXT | - | 否 | - | 浏览器信息 |
| request_data | JSONB | - | 否 | - | 请求数据 |
| response_status | INTEGER | - | 否 | - | 响应状态码 |
| created_at | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY: `id`
- INDEX: `idx_logs_user` ON `user_id`
- INDEX: `idx_logs_action` ON `action`
- INDEX: `idx_logs_created` ON `created_at`
- FOREIGN KEY: `user_id` REFERENCES `users(id)`

---

## 8. 文件管理模块

### 8.1 文件上传表 (file_uploads)

存储所有上传文件的信息。

| 字段名 | 数据类型 | 长度 | 是否必填 | 默认值 | 说明 |
|--------|---------|------|---------|--------|------|
| id | UUID | - | 是 | uuid_generate_v4() | 主键 |
| file_name | VARCHAR | 255 | 是 | - | 文件名 |
| original_name | VARCHAR | 255 | 是 | - | 原始文件名 |
| file_path | VARCHAR | 500 | 是 | - | 文件路径 |
| file_url | VARCHAR | 500 | 是 | - | 访问URL |
| file_size | BIGINT | - | 是 | - | 文件大小（字节） |
| file_type | VARCHAR | 100 | 否 | - | MIME类型 |
| file_extension | VARCHAR | 20 | 否 | - | 文件扩展名 |
| uploader_id | UUID | - | 是 | - | 上传者ID |
| uploader_role | VARCHAR | 20 | 是 | - | 上传者角色 |
| upload_purpose | VARCHAR | 50 | 否 | - | 上传用途：survey/knowledge/avatar |
| related_id | UUID | - | 否 | - | 关联ID |
| status | VARCHAR | 20 | 是 | 'active' | 状态 |
| created_at | TIMESTAMP | - | 是 | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY: `id`
- INDEX: `idx_files_uploader` ON `uploader_id`
- INDEX: `idx_files_purpose` ON `upload_purpose`
- INDEX: `idx_files_related` ON `related_id`
- FOREIGN KEY: `uploader_id` REFERENCES `users(id)`

---

## 数据库关系图

```
users (用户表)
  ├── students (学生表) - user_id
  ├── teachers (教师表) - user_id
  ├── courses (课程表) - teacher_id
  ├── classes (班级表) - teacher_id
  ├── surveys (问卷表) - teacher_id
  └── knowledge_documents (知识库) - teacher_id

students (学生表)
  ├── qa_records (问答记录) - student_id
  ├── survey_responses (答卷) - student_id
  └── questionnaire_submissions (提交记录) - student_id

surveys (问卷表)
  ├── questions (题目表) - survey_id
  ├── survey_responses (答卷表) - survey_id
  ├── questionnaire_submissions (提交记录) - survey_id
  └── survey_statistics (统计) - survey_id

questions (题目表)
  └── answers (答案表) - question_id

survey_responses (答卷表)
  └── answers (答案表) - response_id

courses (课程表)
  ├── classes (班级表) - course_id
  └── knowledge_documents (知识库) - course_id

knowledge_documents (知识库文档)
  └── document_chunks (文档片段) - document_id
```

---

## 数据库初始化脚本

### 启用UUID扩展
```sql
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
```

### 启用向量扩展（如使用pgvector）
```sql
CREATE EXTENSION IF NOT EXISTS vector;
```

### 创建更新时间触发器函数
```sql
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';
```

### 为每个表添加更新触发器（示例）
```sql
CREATE TRIGGER update_users_updated_at 
BEFORE UPDATE ON users 
FOR EACH ROW 
EXECUTE FUNCTION update_updated_at_column();
```

---

## 性能优化建议

### 1. 索引优化
- 为高频查询字段创建索引
- 使用复合索引优化多条件查询
- 定期分析和重建索引

### 2. 分区策略
对于大表考虑分区：
- `qa_records` 按时间分区（月度）
- `operation_logs` 按时间分区（月度）
- `survey_responses` 按创建时间分区

### 3. 查询优化
- 使用物化视图存储复杂统计结果
- 对统计表定期汇总，避免实时计算
- 使用连接池管理数据库连接

### 4. 数据归档
- 定期归档历史数据
- 对超过1年的日志数据进行归档
- 对已关闭问卷的详细数据考虑归档

---

## 安全建议

1. **数据加密**
   - 密码使用bcrypt加密
   - 敏感信息字段考虑加密存储

2. **访问控制**
   - 实现行级安全策略（RLS）
   - 不同角色使用不同数据库用户

3. **数据备份**
   - 每日全量备份
   - 实时增量备份
   - 定期演练恢复流程

4. **审计日志**
   - 记录所有数据修改操作
   - 定期审查异常操作

---

## 版本控制

### v1.0.0 (2026-01-26)
- 初始数据库设计
- 包含用户、课程、问卷、问答、知识库等核心模块

### 后续计划
- v1.1.0: 增加讨论区模块
- v1.2.0: 增加作业提交模块
- v1.3.0: 增加直播课程模块

---

## 附录

### A. 常用查询示例

#### 1. 查询教师创建的所有问卷
```sql
SELECT s.*, 
       COUNT(DISTINCT sr.student_id) as participant_count,
       AVG(sr.total_score) as avg_score
FROM surveys s
LEFT JOIN survey_responses sr ON s.id = sr.survey_id
WHERE s.teacher_id = 'teacher_uuid'
GROUP BY s.id
ORDER BY s.created_at DESC;
```

#### 2. 查询学生的学习统计
```sql
SELECT 
    u.full_name,
    COUNT(DISTINCT sr.survey_id) as surveys_completed,
    AVG(sr.total_score) as avg_score,
    COUNT(DISTINCT qa.id) as questions_asked
FROM users u
LEFT JOIN survey_responses sr ON u.id = sr.student_id
LEFT JOIN qa_records qa ON u.id = qa.student_id
WHERE u.id = 'student_uuid'
GROUP BY u.id, u.full_name;
```

#### 3. 问卷详细分析
```sql
SELECT 
    q.question_text,
    q.question_type,
    COUNT(a.id) as answer_count,
    AVG(a.score) as avg_score,
    SUM(CASE WHEN a.is_correct THEN 1 ELSE 0 END)::FLOAT / COUNT(a.id) as correct_rate
FROM questions q
LEFT JOIN answers a ON q.id = a.question_id
WHERE q.survey_id = 'survey_uuid'
GROUP BY q.id, q.question_text, q.question_type
ORDER BY q.question_order;
```

---

**文档维护**: 本文档应随系统开发进度持续更新
**最后更新**: 2026-01-26
